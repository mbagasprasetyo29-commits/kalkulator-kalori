<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator Kalori — Satu Makan</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F7FAFC; /* very light */
      --card:#FFFFFF;
      --accent-blue:#AEE4FF; /* karbo */
      --accent-green:#C4F4D7; /* protein */
      --accent-yellow:#FFF1B8; /* lemak */
      --primary:#05668D; /* text accent */
      --muted:#6B7280;
      --success:#16A34A;
      --warning:#F59E0B;
      --danger:#EF4444;
      --radius:16px;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0F172A;line-height:1.4}
    .container{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:64px;height:64px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-green));border-radius:14px;display:flex;align-items:center;justify-content:center;color:#053;box-shadow:0 6px 18px rgba(4,7,23,0.06);font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 6px 20px rgba(12,15,30,0.05)}

    /* layout */
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media (max-width:880px){.col-6{grid-column:span 12}}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #E6E9EE;font-size:14px}
    .two{display:flex;gap:10px}
    .two > *{flex:1}

    .btn{display:inline-flex;gap:10px;align-items:center;padding:10px 14px;border-radius:999px;border:0;background:var(--primary);color:white;font-weight:600;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--primary);border:1px solid rgba(5,102,141,0.08)}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid #E6E9EE}

    .result-grid{display:grid;grid-template-columns:1fr 240px;gap:16px}
    @media (max-width:820px){.result-grid{grid-template-columns:1fr}}

    .big-number{font-size:28px;font-weight:700}
    .muted{color:var(--muted);font-size:13px}

    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#F1F5F9;color:var(--muted);font-weight:600}

    .verdict{display:flex;gap:12px;align-items:center}
    .verdict .dot{width:12px;height:12px;border-radius:50%}
    .verdict p{margin:0}

    .menu-list{margin:8px 0;padding-left:16px}
    .menu-list li{margin-bottom:8px}

    .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* small animations */
    .fade-in{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* error */
    .error{color:var(--danger);font-size:12px;margin-top:6px}

    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:#F8FAFC;border:1px solid #EEF2FF;font-weight:600;font-size:13px}

    .tips{background:linear-gradient(180deg,#fff,#fbfdfc);padding:12px;border-radius:12px;border:1px solid #F0F6F4}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">KK</div>
      <div>
        <h1>Kalkulator Kalori — Satu Makan</h1>
        <p class="lead">Masukkan data diri & satu makanan. Hasil instan, saran makan selanjutnya, grafik, dan PDF.</p>
      </div>
    </header>

    <main class="grid">
      <!-- Form Data Diri -->
      <div class="card col-6 fade-in">
        <h3 style="margin-top:0;margin-bottom:8px">Data Diri</h3>
        <div style="display:grid;gap:10px">
          <div>
            <label>Nama</label>
            <input id="nama" type="text" placeholder="Contoh: Bagas" />
          </div>
          <div class="two">
            <div>
              <label>Umur (tahun)</label>
              <input id="umur" type="number" min="5" max="120" placeholder="17" />
            </div>
            <div>
              <label>Jenis Kelamin</label>
              <select id="jenisKelamin">
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>
          </div>

          <div class="two">
            <div>
              <label>Berat (kg)</label>
              <input id="berat" type="number" min="20" max="300" step="0.1" placeholder="60" />
            </div>
            <div>
              <label>Tinggi (cm)</label>
              <input id="tinggi" type="number" min="70" max="260" step="0.1" placeholder="165" />
            </div>
          </div>

          <div>
            <label>Aktivitas Harian</label>
            <select id="aktivitas">
              <option value="1.2">Sangat kurang aktif (sedikit atau tidak ada olahraga)</option>
              <option value="1.375">Kurang aktif (aktivitas ringan sehari-hari)</option>
              <option value="1.55" selected>Cukup aktif (olahraga 1–3x/minggu)</option>
              <option value="1.725">Aktif (olahraga 3–5x/minggu)</option>
              <option value="1.9">Sangat aktif (aktivitas fisik berat/hari)</option>
            </select>
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
            <button id="saveLocal" class="btn secondary">Simpan Terakhir</button>
            <button id="clearLocal" class="btn ghost">Reset Simpanan</button>
            <div style="flex:1"></div>
            <span class="muted">Data disimpan hanya di perangkat Anda.</span>
          </div>
        </div>
      </div>

      <!-- Form Makanan -->
      <div class="card col-6 fade-in">
        <h3 style="margin-top:0;margin-bottom:8px">Informasi Makanan (Satu Makan)</h3>
        <div style="display:grid;gap:10px">
          <div>
            <label>Jenis Makan</label>
            <select id="jenisMakan">
              <option value="Sarapan">Sarapan</option>
              <option value="Makan Siang">Makan Siang</option>
              <option value="Makan Malam">Makan Malam</option>
              <option value="Snack">Snack</option>
            </select>
          </div>
          <div>
            <label>Nama Makanan (bebas)</label>
            <input id="namaMakanan" type="text" placeholder="Contoh: Nasi Goreng" />
          </div>
          <div class="two">
            <div>
              <label>Karbohidrat (gram)</label>
              <input id="karbo" type="number" min="0" step="0.1" placeholder="g" />
            </div>
            <div>
              <label>Protein (gram)</label>
              <input id="protein" type="number" min="0" step="0.1" placeholder="g" />
            </div>
          </div>
          <div>
            <label>Lemak (gram)</label>
            <input id="lemak" type="number" min="0" step="0.1" placeholder="g" />
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            <button id="hitung" class="btn">Hitung Kalori</button>
            <button id="reset" class="btn ghost">Reset Form</button>
            <div style="flex:1"></div>
            <div class="tag">Formula: 1g Karbo/Protein = 4 kcal, 1g Lemak = 9 kcal</div>
          </div>
          <div id="formError" class="error" style="display:none"></div>
        </div>
      </div>

      <!-- Result -->
      <div class="card col-12 fade-in">
        <div class="result-grid">
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <div class="muted">Hasil Perhitungan</div>
                <div class="big-number" id="kaloriTotal">- kcal</div>
                <div class="muted" id="persentaseSesi">- dari kebutuhan sesi</div>
              </div>

              <div style="text-align:right">
                <div class="muted">BMR</div>
                <div id="bmrVal" class="big-number">-</div>
                <div class="muted">TDEE</div>
                <div id="tdeeVal">- kcal/hari</div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
              <div id="verdictBox" style="flex:1;padding:12px;border-radius:12px;background:#FBFFFB;border:1px solid #EEF9F0;display:flex;align-items:center;gap:12px">
                <div style="width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-green));display:flex;align-items:center;justify-content:center;font-weight:700;color:#053">OK</div>
                <div>
                  <div id="verdictTitle" style="font-weight:700">Belum dihitung</div>
                  <div id="verdictMsg" class="muted">Hasil akan muncul setelah Anda klik &quot;Hitung Kalori&quot;.</div>
                </div>
              </div>
              <div style="width:120px;text-align:center">
                <div class="muted">Status</div>
                <div id="statusTag" class="tag">-</div>
              </div>
            </div>

            <div style="margin-top:14px" id="detailBox">
              <div class="muted">Rincian Makro</div>
              <div style="display:flex;gap:20px;margin-top:8px;flex-wrap:wrap">
                <div class="chip">Karbo: <span id="karboG">- g</span> (<span id="karboKcal">- kcal</span>)</div>
                <div class="chip">Protein: <span id="proteinG">- g</span> (<span id="proteinKcal">- kcal</span>)</div>
                <div class="chip">Lemak: <span id="lemakG">- g</span> (<span id="lemakKcal">- kcal</span>)</div>
              </div>
            </div>

            <div style="margin-top:14px">
              <div class="muted">Rekomendasi & Saran</div>
              <div id="saranBox" style="margin-top:8px"></div>
            </div>
          </div>

          <div>
            <div class="card" style="padding:12px;margin:0">
              <canvas id="chartMakro" width="240" height="240" style="max-width:100%"></canvas>
              <div style="display:flex;justify-content:space-between;margin-top:10px">
                <div class="muted">Legend</div>
                <div class="muted">Keterangan</div>
              </div>
              <div style="display:flex;gap:8px;flex-direction:column;margin-top:10px">
                <div class="muted">Karbo: <span id="karboPct">-</span></div>
                <div class="muted">Protein: <span id="proteinPct">-</span></div>
                <div class="muted">Lemak: <span id="lemakPct">-</span></div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
              <button id="downloadPdf" class="btn">Download PDF</button>
              <button id="shareWa" class="btn secondary">Share ke WhatsApp</button>
              <button id="tipsBtn" class="btn ghost">Tampilkan Tips Nutrisi</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card col-12 fade-in">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">Tips Nutrisi</div>
            <div class="muted">Tips akan muncul secara acak tiap submit.</div>
          </div>
          <div id="lastSaved" class="muted">Data belum disimpan</div>
        </div>

        <div style="margin-top:12px" id="tipsArea">
          <div class="tips">Tekan "Hitung Kalori" untuk menampilkan tips yang relevan.</div>
        </div>
      </div>

      <div class="col-12" style="text-align:center;margin-top:8px">
        <div class="footer">Template oleh Kalkulator Kalori • Data hanya di perangkat Anda • Responsive & siap embed</div>
      </div>
    </main>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // Helper & state
    const $ = (id)=>document.getElementById(id);

    const state = {chart:null};

    // Utility functions
    function fmt(n){return Math.round(n)}
    function safeNum(v){const n = parseFloat(v); return isNaN(n)?0:n}

    // Tips bank (sample, can be expanded)
    const tipsBank = [
      'Tambahkan protein di setiap makan untuk rasa kenyang lebih lama.',
      'Pilih karbo kompleks (beras merah, ubi, gandum utuh) untuk energi stabil.',
      'Perbanyak sayuran berwarna untuk serat dan mikronutrien.',
      'Batasi gorengan yang tinggi lemak jenuh; pilih metode panggang atau kukus.',
      'Minum air putih sebelum makan dapat membantu kontrol porsi.'
    ];

    // Menu contoh lokal (estimasi kcal per porsi)
    const contohMenu = {
      'Sarapan':[{
        title:'Nasi + Telur Dadar + Sayur', kcal:380, note:'Nasi 100g + 1 telur + sayur'
      },{
        title:'Oatmeal + Susu + Pisang', kcal:360, note:'Oat + susu rendah lemak + 1 buah pisang'
      }],
      'Makan Siang':[{
        title:'Nasi + Dada Ayam + Sayur', kcal:650, note:'Nasi 150g + ayam 120g + sayur'
      },{
        title:'Nasi + Ikan + Tumis Sayur', kcal:620, note:'Nasi 150g + ikan 120g + sayur'
      }],
      'Makan Malam':[{
        title:'Nasi sedikit + Tahu/Tempe + Sayur', kcal:420, note:'Porsi lebih ringan di malam hari'
      },{
        title:'Salad + Protein (Ayam/Tofu)', kcal:380, note:'Makan malam rendah karbo untuk malam hari'}],
      'Snack':[{
        title:'Pisang + Selai Kacang', kcal:220, note:'1 buah pisang + 1 sdm selai kacang'
      },{
        title:'Yoghurt + Granola', kcal:200, note:'Porsi kecil sebagai snack'}]
    };

    // Validation rules
    function validateInputs(){
      const nama = $('nama').value.trim();
      const umur = safeNum($('umur').value);
      const berat = safeNum($('berat').value);
      const tinggi = safeNum($('tinggi').value);
      const karbo = safeNum($('karbo').value);
      const protein = safeNum($('protein').value);
      const lemak = safeNum($('lemak').value);
      let err = '';
      if(!nama) err = 'Nama wajib diisi.';
      else if(!(umur>=5 && umur<=120)) err = 'Umur harus antara 5 - 120 tahun.';
      else if(!(berat>=20 && berat<=300)) err='Berat harus antara 20 - 300 kg.';
      else if(!(tinggi>=70 && tinggi<=260)) err='Tinggi harus antara 70 - 260 cm.';
      else if(karbo===0 && protein===0 && lemak===0) err='Masukkan setidaknya salah satu makro (karbo/protein/lemak).';
      if(err){
        $('formError').style.display='block';
        $('formError').textContent = err;
        return false;
      }
      $('formError').style.display='none';
      return true;
    }

    // Calculations
    function calcBMR(jk, berat, tinggi, umur){
      if(jk==='L') return 10*berat + 6.25*tinggi - 5*umur + 5;
      return 10*berat + 6.25*tinggi - 5*umur - 161;
    }

    function calcCalories(karbo, protein, lemak){
      const karboK = karbo*4;
      const proteinK = protein*4;
      const lemakK = lemak*9;
      return {karboK, proteinK, lemakK, total:karboK+proteinK+lemakK};
    }

    // Session percent ranges
    const sessionRanges = {
      'Sarapan':[0.25,0.30],
      'Makan Siang':[0.30,0.35],
      'Makan Malam':[0.25,0.30],
      'Snack':[0.05,0.10]
    };

    // Verdict logic
    function evaluate(kaloriMakanan, tdee, jenisMakan){
      const [minP,maxP] = sessionRanges[jenisMakan];
      const targetMin = tdee * minP; const targetMax = tdee * maxP;
      const targetMedian = (targetMin + targetMax)/2;
      const deltaPercent = ((kaloriMakanan - targetMedian)/targetMedian)*100;
      let status='Sesuai'; let color='--success';
      if(Math.abs(deltaPercent) <= 15) { status='Sesuai'; color='--success'; }
      else if(deltaPercent < -15){ status='Kekurangan'; color='--warning'; }
      else { status='Kelebihan'; color='--danger'; }
      return {targetMin,targetMax,targetMedian,deltaPercent,status,color};
    }

    // Recommendation engine (simplified but practical)
    function recommend({status,deltaPercent,kaloriMakanan,tdee,jenisMakan,karbo,protein,lemak}){
      const rekom = [];
      const deficit = Math.max(0, Math.round(( (tdee*((sessionRanges[jenisMakan][0]+sessionRanges[jenisMakan][1])/2)) - kaloriMakanan )));
      const surplus = Math.max(0, Math.round(kaloriMakanan - (tdee*((sessionRanges[jenisMakan][0]+sessionRanges[jenisMakan][1])/2))))

      // Analyze macro dominance
      const macros = [{k:'karbo',v:karbo},{k:'protein',v:protein},{k:'lemak',v:lemak}];
      macros.sort((a,b)=>b.v-a.v);
      const dominant = macros[0].k; // highest gram

      if(status==='Kekurangan'){
        rekom.push(`<strong>Kekurangan ≈ ${deficit} kcal</strong>. Untuk menyesuaikan kebutuhan sesi, pertimbangkan menambah energi pada makan selanjutnya:`);
        // tailored suggestions
        if(jenisMakan==='Sarapan'){
          rekom.push('<em>Saran untuk makan siang:</em> Tambah sumber protein + karbo. Contoh: Dada ayam 100–120g + nasi 100–150g.');
        } else if(jenisMakan==='Makan Siang'){
          rekom.push('<em>Saran untuk makan malam:</em> Tambah lauk protein (telur, tahu/tempe) dan sedikit karbo kompleks.');
        } else if(jenisMakan==='Makan Malam'){
          rekom.push('<em>Saran:</em> Jika masih lapar, tambahkan snack sehat (pisang + selai kacang) atau yoghurt.');
        } else {
          rekom.push('<em>Saran:</em> Tambah porsi pada makan utama berikutnya (lebih protein & karbo).');
        }
        // quantify suggestion
        if(deficit>0){
          if(deficit <= 150) rekom.push('- Tambah 1 porsi buah + 1 sdm selai kacang (~150 kcal).');
          else if(deficit <= 350) rekom.push('- Tambah 1 porsi protein (ayam 100g) + sedikit karbo (~300 kcal).');
          else rekom.push('- Pertimbangkan menambah porsi utama (nasi + protein) pada makan berikutnya untuk menutup kekurangan.');
        }

      } else if(status==='Kelebihan'){
        rekom.push(`<strong>Kelebihan ≈ ${surplus} kcal</strong>. Pertimbangkan langkah berikut:`);
        if(jenisMakan==='Makan Malam'){
          rekom.push('- Untuk makan malam berikutnya, pilih porsi lebih kecil, lebih banyak sayur, kurangi karbo berat.');
        } else {
          rekom.push('- Kurangi porsi di makan berikutnya dan pilih makanan rendah lemak,jaga total harian agar tidak melebihi TDEE.');
        }
        rekom.push('- Aktivitas fisik ringan (jalan 20-30 menit) bisa membantu membakar sebagian kalori ekstra.');
      } else {
        rekom.push('<strong>Sudah sesuai.</strong> Pertahankan porsi dan variasi nutrisi. Untuk hari ini, usahakan konsistensi agar total harian mendekati kebutuhan.');
      }

      // Add 3 example menus
      const contoh = contohMenu[jenisMakan] || [];
      rekom.push('<strong>Contoh menu yang sesuai:</strong>');
      contoh.slice(0,3).forEach(m=>{rekom.push(`- ${m.title} (~${m.kcal} kcal) — ${m.note}`)});

      return rekom.join('<br>');
    }

    // Render chart
    function renderChart(karbo,protein,lemak){
      const ctx = $('chartMakro').getContext('2d');
      const data = [karbo,protein,lemak];
      if(state.chart) state.chart.destroy();
      state.chart = new Chart(ctx,{type:'pie',data:{labels:['Karbo','Protein','Lemak'],datasets:[{data:data,backgroundColor:['#AEE4FF','#C4F4D7','#FFF1B8'],borderColor:'#fff',borderWidth:2}]},options:{plugins:{legend:{display:true,position:'bottom'}},animation:{duration:600}});
    }

    // Update UI
    function updateUI(res){
      $('kaloriTotal').textContent = fmt(res.total) + ' kcal';
      $('persentaseSesi').textContent = Math.round((res.total / res.targetMedian)*100) + '% dari kebutuhan sesi';
      $('bmrVal').textContent = fmt(res.bmr);
      $('tdeeVal').textContent = fmt(res.tdee) + ' kcal/hari';
      $('karboG').textContent = res.karbo + ' g';
      $('proteinG').textContent = res.protein + ' g';
      $('lemakG').textContent = res.lemak + ' g';
      $('karboKcal').textContent = fmt(res.karboK) + ' kcal';
      $('proteinKcal').textContent = fmt(res.proteinK) + ' kcal';
      $('lemakKcal').textContent = fmt(res.lemakK) + ' kcal';
      $('karboPct').textContent = Math.round((res.karboK / res.total)*100) + '%';
      $('proteinPct').textContent = Math.round((res.proteinK / res.total)*100) + '%';
      $('lemakPct').textContent = Math.round((res.lemakK / res.total)*100) + '%';

      // verdict
      const verdictTitle = (res.eval.status==='Sesuai')? 'Sesuai kebutuhan' : (res.eval.status==='Kekurangan')? 'Kekurangan kalori' : 'Kelebihan kalori';
      $('verdictTitle').textContent = verdictTitle;
      $('verdictMsg').innerHTML = (res.eval.deltaPercent? ('Perubahan relatif: ' + Math.round(res.eval.deltaPercent) + '%') : '');
      $('statusTag').textContent = res.eval.status;
      if(res.eval.status==='Sesuai') $('statusTag').style.background='#ECFDF5', $('statusTag').style.color='var(--success)';
      else if(res.eval.status==='Kekurangan') $('statusTag').style.background='#FFFBEB', $('statusTag').style.color='var(--warning)';
      else $('statusTag').style.background='#FEF2F2', $('statusTag').style.color='var(--danger)';

      $('saranBox').innerHTML = recommend(res);

      renderChart(res.karbo,res.protein,res.lemak);

      // tips
      const tip = tipsBank[Math.floor(Math.random()*tipsBank.length)];
      $('tipsArea').innerHTML = `<div class="tips">${tip}</div>`;
    }

    // Main compute
    function computeAll(){
      if(!validateInputs()) return;
      // read inputs
      const nama = $('nama').value.trim();
      const umur = safeNum($('umur').value);
      const jenisKelamin = $('jenisKelamin').value;
      const berat = safeNum($('berat').value);
      const tinggi = safeNum($('tinggi').value);
      const aktivitas = safeNum($('aktivitas').value);
      const jenisMakan = $('jenisMakan').value;
      const namaMakanan = $('namaMakanan').value.trim() || '-';
      const karbo = safeNum($('karbo').value);
      const protein = safeNum($('protein').value);
      const lemak = safeNum($('lemak').value);

      // calculations
      const bmr = calcBMR(jenisKelamin,berat,tinggi,umur);
      const tdee = bmr * aktivitas;
      const {karboK,proteinK,lemakK,total} = calcCalories(karbo,protein,lemak);
      const evalObj = evaluate(total, tdee, jenisMakan);

      const res = {nama,umur,jenisKelamin,berat,tinggi,aktivitas,jenisMakan,namaMakanan,karbo,protein,lemak,karboK,proteinK,lemakK,total,bmr,tdee,eval:evalObj,targetMedian:evalObj.targetMedian};
      updateUI(res);
      // save last
      localStorage.setItem('kalkulatorKalori_lastInput_v1', JSON.stringify({nama,umur,jenisKelamin,berat,tinggi,aktivitas,jenisMakan,namaMakanan,karbo,protein,lemak}));
      $('lastSaved').textContent = 'Data terakhir disimpan otomatis.';
    }

    // PDF generation
    async function downloadPDF(){
      const docArea = document.querySelector('.result-grid');
      // render whole result card as image
      const canvas = await html2canvas(document.querySelector('main'), {scale:1.6, useCORS:true});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      // fit image into page width with margin
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pageWidth - 40;
      const pdfHeight = (imgProps.height * pdfWidth)/imgProps.width;
      pdf.addImage(imgData,'PNG',20,20,pdfWidth,pdfHeight);
      const namaFile = `Laporan-Kalori-${($('nama').value||'User')}-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
      pdf.save(namaFile);
    }

    // Share WA
    function shareWhatsApp(){
      const nama = $('nama').value.trim() || '-';
      const makanan = $('namaMakanan').value.trim() || '-';
      const kal = $('kaloriTotal').textContent;
      const status = $('statusTag').textContent || '-';
      const saran = (document.getElementById('saranBox').innerText || '').split('\n').slice(0,3).join(' ');
      const text = `Hasil Kalkulator Kalori:\nNama: ${nama}\nMakanan: ${makanan}\nKalori: ${kal}\nEvaluasi: ${status}\nSaran singkat: ${saran}`;
      const url = 'https://wa.me/?text=' + encodeURIComponent(text);
      window.open(url,'_blank');
    }

    // Persist / load last
    function loadLast(){
      try{
        const raw = localStorage.getItem('kalkulatorKalori_lastInput_v1');
        if(!raw) return;
        const d = JSON.parse(raw);
        $('nama').value = d.nama || '';
        $('umur').value = d.umur || '';
        $('jenisKelamin').value = d.jenisKelamin || 'L';
        $('berat').value = d.berat || '';
        $('tinggi').value = d.tinggi || '';
        $('aktivitas').value = d.aktivitas || '1.55';
        $('jenisMakan').value = d.jenisMakan || 'Sarapan';
        $('namaMakanan').value = d.namaMakanan || '';
        $('karbo').value = d.karbo || '';
        $('protein').value = d.protein || '';
        $('lemak').value = d.lemak || '';
        $('lastSaved').textContent = 'Data terakhir dimuat dari penyimpanan.';
      }catch(e){console.warn(e)}
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded',()=>{
      loadLast();
      $('hitung').addEventListener('click',()=>{computeAll();});
      $('reset').addEventListener('click',()=>{ if(confirm('Reset semua input?')) location.reload(); });
      $('saveLocal').addEventListener('click',()=>{
        try{
          const payload = {nama:$('nama').value,umur:$('umur').value,jenisKelamin:$('jenisKelamin').value,berat:$('berat').value,tinggi:$('tinggi').value,aktivitas:$('aktivitas').value,jenisMakan:$('jenisMakan').value,namaMakanan:$('namaMakanan').value,karbo:$('karbo').value,protein:$('protein').value,lemak:$('lemak').value};
          localStorage.setItem('kalkulatorKalori_lastInput_v1',JSON.stringify(payload));
          $('lastSaved').textContent = 'Data disimpan.';
          alert('Data berhasil disimpan di browser Anda.');
        }catch(e){alert('Gagal menyimpan: '+e.message)}
      });
      $('clearLocal').addEventListener('click',()=>{ if(confirm('Hapus penyimpanan terakhir?')){ localStorage.removeItem('kalkulatorKalori_lastInput_v1'); $('lastSaved').textContent='Penyimpanan dihapus.';} });
      $('downloadPdf').addEventListener('click',()=>{ downloadPDF(); });
      $('shareWa').addEventListener('click',()=>{ shareWhatsApp(); });
      $('tipsBtn').addEventListener('click',()=>{ const tip = tipsBank[Math.floor(Math.random()*tipsBank.length)]; $('tipsArea').innerHTML = `<div class="tips">${tip}</div>`; });
    });
  </script>
</body>
</html>
